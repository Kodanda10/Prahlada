import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, waitFor } from '../test-utils';
import Analytics from '../../pages/Analytics';

// Mock the fetch API
global.fetch = vi.fn();

// Mock Recharts to avoid rendering issues in tests
vi.mock('recharts', () => {
  const OriginalModule = vi.importActual('recharts');
  return {
    ...OriginalModule,
    ResponsiveContainer: ({ children }: any) => <div style={{ width: 800, height: 800 }}>{children}</div>,
    PieChart: ({ children }: any) => <div>{children}</div>,
    Pie: () => <div>Pie Chart</div>,
    BarChart: ({ children }: any) => <div>{children}</div>,
    Bar: () => <div>Bar Chart</div>,
    XAxis: () => <div>XAxis</div>,
    YAxis: () => <div>YAxis</div>,
    Tooltip: () => <div>Tooltip</div>,
    Legend: () => <div>Legend</div>,
    Cell: () => <div>Cell</div>,
    CartesianGrid: () => <div>CartesianGrid</div>,
  };
});

// Mock MapBoxVisual and HierarchyMindMap as they might use canvas or complex DOM
vi.mock('../../components/analytics/MapBoxVisual', () => ({
  default: () => <div data-testid="mapbox-visual">MapBox Visual</div>
}));

vi.mock('../../components/analytics/HierarchyMindMap', () => ({
  default: () => <div data-testid="hierarchy-mindmap">Hierarchy MindMap</div>
}));

vi.mock('../../services/api', () => ({
  apiService: {
    get: vi.fn(() => Promise.resolve({
      titles: { analytics_tab: 'Analytics' },
      modules: { analytics: true }
    })),
  },
  fetchAnalyticsData: vi.fn(() => Promise.resolve([])),
}));

describe('Analytics Page', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('renders the analytics dashboard sections', async () => {
    render(<Analytics />);

    // Check for main section titles in Hindi
    expect(screen.getByText(/इवेंट प्रकार विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/भू-मानचित्रण एवं कवरेज/i)).toBeInTheDocument();
    expect(screen.getByText(/टूर कवरेज विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/विकास कार्य विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/समाज आधारित पहुँच/i)).toBeInTheDocument();
    expect(screen.getByText(/योजना विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/लक्षित वर्ग विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/विषयगत विश्लेषण/i)).toBeInTheDocument();
    expect(screen.getByText(/रायगढ़ विधानसभा/i)).toBeInTheDocument();
  });

  it('renders filter dropdowns', async () => {
    render(<Analytics />);

    // Check for filter options
    expect(screen.getByText(/सभी स्थान/i)).toBeInTheDocument();
    expect(screen.getByText(/सभी विषय/i)).toBeInTheDocument();
  });

  it('renders visualization components', async () => {
    render(<Analytics />);

    // Check if mocked visualizations are present
    expect(screen.getByTestId('mapbox-visual')).toBeInTheDocument();
  });
});
